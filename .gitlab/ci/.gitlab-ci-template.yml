# Aegis CI Template for GitLab CI
# Copy this file to your repository as .gitlab-ci.yml

variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  AEGIS_API_URL: $AEGIS_API_URL
  DOCKER_DRIVER: overlay2

stages:
  - build
  - scan
  - sign
  - upload

build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker save $IMAGE_NAME:$IMAGE_TAG -o image.tar
  artifacts:
    paths:
      - image.tar
    expire_in: 1 hour

sbom:
  stage: scan
  image: anchore/syft:latest
  dependencies:
    - build
  script:
    - docker load -i image.tar
    - syft packages $IMAGE_NAME:$IMAGE_TAG -o spdx-json=sbom.spdx.json
  artifacts:
    paths:
      - sbom.spdx.json
    expire_in: 90 days

scan:
  stage: scan
  image: anchore/grype:latest
  dependencies:
    - build
  script:
    - docker load -i image.tar
    - grype $IMAGE_NAME:$IMAGE_TAG -o json=vulnerabilities.json --fail-on critical
  artifacts:
    paths:
      - vulnerabilities.json
    expire_in: 90 days
  allow_failure: false

sign:
  stage: sign
  image: gcr.io/projectsigstore/cosign:latest
  dependencies:
    - build
    - sbom
  script:
    - docker load -i image.tar
    - cosign sign --yes $IMAGE_NAME:$IMAGE_TAG
    - cosign attest --yes --predicate sbom.spdx.json --type spdx $IMAGE_NAME:$IMAGE_TAG

upload_to_aegis:
  stage: upload
  image: curlimages/curl:latest
  dependencies:
    - sbom
    - scan
  script:
    - |
      curl -X POST "${AEGIS_API_URL}/api/v1/scans/upload" \
        -H "Authorization: Bearer ${AEGIS_API_TOKEN}" \
        -H "Content-Type: application/json" \
        -d @- <<EOF
      {
        "projectName": "${CI_PROJECT_PATH}",
        "buildId": "${CI_PIPELINE_ID}",
        "imageDigest": "${IMAGE_TAG}",
        "gitCommitSha": "${CI_COMMIT_SHA}",
        "gitBranch": "${CI_COMMIT_REF_NAME}",
        "ciPipelineUrl": "${CI_PIPELINE_URL}",
        "sbom": $(cat sbom.spdx.json),
        "vulnerabilities": $(cat vulnerabilities.json)
      }
      EOF
