name: SBOM Generation & Vulnerability Scanning

on:
  workflow_call:
    inputs:
      image_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
    secrets:
      AEGIS_API_URL:
        required: true
      AEGIS_API_TOKEN:
        required: true

env:
  SYFT_VERSION: 'v1.0.1'
  GRYPE_VERSION: 'v0.74.0'
  COSIGN_VERSION: 'v2.2.2'

jobs:
  sbom-scan:
    name: Generate SBOM & Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ inputs.image_name }}:${{ inputs.image_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin ${{ env.SYFT_VERSION }}

      - name: Generate SBOM (SPDX 2.3)
        run: |
          syft packages \
            ${{ inputs.image_name }}:${{ inputs.image_tag }} \
            -o spdx-json \
            --file sbom-spdx.json

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-spdx-${{ github.sha }}
          path: sbom-spdx.json
          retention-days: 90

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin ${{ env.GRYPE_VERSION }}

      - name: Scan for vulnerabilities
        run: |
          grype ${{ inputs.image_name }}:${{ inputs.image_tag }} \
            -o json \
            --file grype-results.json

      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: grype-results-${{ github.sha }}
          path: grype-results.json
          retention-days: 90

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: ${{ env.COSIGN_VERSION }}

      - name: Sign image (keyless)
        run: |
          cosign sign --yes \
            ${{ inputs.image_name }}:${{ inputs.image_tag }}

      - name: Attest SBOM
        run: |
          cosign attest --yes \
            --predicate sbom-spdx.json \
            --type spdx \
            ${{ inputs.image_name }}:${{ inputs.image_tag }}

      - name: Upload evidence to Aegis API
        run: |
          curl -X POST "${{ secrets.AEGIS_API_URL }}/api/v1/scans/upload" \
            -H "Authorization: Bearer ${{ secrets.AEGIS_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "projectName": "${{ github.repository }}",
            "buildId": "${{ github.run_id }}",
            "imageDigest": "$(docker inspect --format='{{index .RepoDigests 0}}' ${{ inputs.image_name }}:${{ inputs.image_tag }} | cut -d@ -f2)",
            "gitCommitSha": "${{ github.sha }}",
            "gitBranch": "${{ github.ref_name }}",
            "sbom": $(cat sbom-spdx.json),
            "vulnerabilities": $(cat grype-results.json)
          }
          EOF

      - name: Fail on critical vulnerabilities
        run: |
          CRITICAL_COUNT=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' grype-results.json)
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "❌ Found $CRITICAL_COUNT critical vulnerabilities"
            exit 1
          fi
          echo "✅ No critical vulnerabilities found"
